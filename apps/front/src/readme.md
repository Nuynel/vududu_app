# Breedelight

## Работа с токенами

Используются 2 токена: токен доступа (`access token`) и токен обновления (`refresh token`)

### Кейсы:
1) пользователь открывает приложение по ссылке и у него нет токенов - он попадает на страницу входа
2) пользователь открывает приложение НЕ по ссылке и у него нет токенов - он попадает на страницу входа
3) пользователь открывает приложение по ссылке и у него есть токен рефреша -
        перезапрашиваем токен доступа и переводим на страницу, указанную в ссылке
4) пользователь открывает приложение НЕ по ссылке и у него есть токен рефреша -
        перезапрашиваем токен доступа и переводим на страницу календаря
5) пользователь находится в приложении и у него умирает токен доступа - перезапрашиваем токены и никуда не редиректим
6) пользователь переключается на другую вкладку (не закрывает вкладку с приложением, а меняет активный таб) -
        срабатывают таймеры и все время поддерживают токен доступа в рабочем состоянии
7) пользователь закрыл вкладку, но вернулся на неё в пределах действия рефреш токена -
        перед инитом приложения срабатывает запрос на обновление токенов

### Как работает логика токенов в клиентской части приложения Breedelight:
1) в корневом файле приложени `index.tsx` перед рендером происходит получения новой пары токенов обновления и доступа
N.B! токен обновления попадает в куки и никак недоступен для приложения, так как с ним взаимодействует только бэкенд
2) если токен обновления рабочий, то пользователя редиректит либо на календарь,
если текущий урл не совпадает с каким-нибудь из списка приватных, либо остается на своем урле без каких-либо редиректов
3) если токен обновления протух, то пользователя редиректит на экран входа
4) !!! происходит рендер приложения
5) пользователь вводит свои креды и в ответе сервера, если все верно, получает токены
6) так как приложение уже отрендерилось, в работу вступает `useEffect` в хуке `useAuth`, завязанный на токене доступа
7) `useEffect` проверяет токен, и так как он есть и действителен, то происходит две вещи:
8) пользователя редиректит на календарь и устанавливается таймаут на обновление токена доступа
9) таким образом, у залогированного пользователя всегда будет свежий токен доступа, пока он не покине приложение

// как добавить собаку?
// 1) добавляемой собаке currentProfileId устанавливается из localStorage
// а если добавляет стороннюю собаку для вызки например? - пока забиваем на этот кейс
// 2) собака - мой выпускник (если галочка - блочим ввод названия питомника откуда выпустилась собака)
// в этот момент проставляем либо startKennelId, либо startKennelName - пока забиваю на это
// 3) ownerId = profileId
// 4) litterId - null
// 5) name - ввод
// 6) fullName - ввод
// 7) breed - ввод (неплохо было бы сделать селект, с другой стороны пород - непочатый край, всех не внесёшь)

// 8) dateOfBirth - ввод -> выбор в календарике
// 9) sex - выбор м/ж
// 10) номер микрочипа - ввод
// 11) color - ввод
// кастрирована собака или нет
//


### Добавление собаки и помета: кейсы
1) Пользователь по отдельности добавляет собаку и помет, а потому линкует их в окне редактирования собаки или помета
2) Пользователь добавляет собаку и указывает её родителей: 
   - при добавлении родителей они либо выбираются из списка уже добавленных особей,
   либо пользователь ставит галочку "Собаки нет в списке" и добавляет её через форму с полями 
   "Полная кличка", "Номер родословной", "Дата рождения", "Порода", "Окрас", добавление файла родословной. 
   - потом либо выбирает помет из уже зарегистрированных у этих родителей, либо нажимает галочку "Помета нет в списке"
   и добавляет новый помет (дата рождения помета не указывается, она берется из данных собаки).
   - если помет уже зарегистрирован - нужна проверка, что при добавлении собаки не будет превышено количество щенков в помете
   - если помет не зарегистрирован, то он добавится и продолжить его заполнение можно будет в карточке помета
3) Пользователь добавляет помет двум собакам, и сразу добавляет к нему щенков:
   - родители либо выбираются из списка уже добавленных собак, либо пользователь ставит галочку "Собаки нет в списке"
   и добавляет её через форму с полями "Полная кличка", "Номер родословной", "Дата рождения", "Порода", "Окрас". 
   - в карточку помета вносятся данные "Дата рождения", "Кол-во кобелей", "Кол-во сук", "Комментарий",
   "Номер общепометной карты", добавление файла общепометной карты.
   - снизу появляется кнопка с фозможностью сразу заполнить карточки щенков: "Пол", "Кличка", "Полная кличка",
   "Окрас", "Номер чипа", "Номер клейма", "Номер щенячки", добавление файла щенячки
   - есть опция выбрать собаку из уже добавленных, у которых нет данных о родителях и помете

#### Необходимые проверки при добавлении собак и пометов:
1) У одной пары не может родиться два помета __в один день__
2) У одной пары не может родиться два помета __с разницей меньше чем 90 дней__
3) Если указано общее количество кобелей и сук в помете, то количество прикрепленных собак не может превышеть эти значения
4) НАД ОСТАЛЬНЫМИ НАДО ПОДУМАТЬ

#### Указание породы 
1) Выбор породы из списка или галочка "Кроссбрид" (выставляется автоматически если у родителей разные породы)
2) Если породы нет в списке - появляется пять инпутов, в первых двух нужно ввести название породы (повторение для избежания ошибок),
во второй паре продублировать название на английском, а в третьем поле небольшое описание и, возможно, ссылка на какую-нибудь статью в интернете.
Так же будет кнопка "+", после нажания которой добавляются поля с альтернативными названиями породы, каждое нужно продублировать.
3) Если порода авторская, то просим доказательства того, что это не кроссбрид, что уже получено поколение F4
4) После заполнения полей появляется уведомление, что на данный момент пользователь может использовать данное название породы,
а добавление в общий список, доступный всем пользователям, произойдет после небольшой модерации на предмет наличия ошибок или опечаток,
а на почту ему придет отчет о результатах модерации. 
5) Порода добавляется в коллекцию с пометкой "Модерируется", а собаке уже добавляется её айдишник.
6) Возможные причины неуспешной модерации:
    - дублирование уже добавленной породы -> в таком кейсе пользователю пишем на почту что данная порода уже добавлена
   и просим подтвердить, если подтверждает, то меняем у собаки или собак айдишники на уже добавленную породу
    - ошибки в описании -> вносим предложения по исправлению, ждем подтверждения от пользователя, после внесения правок добавляем породу
7) По результатам модерации пользователю на почту упадет уведомление с результатами модерации, и, если все успешно, у породы снимается статус "Модерируется"

